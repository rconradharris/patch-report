#!/usr/bin/env python
"""
Refresh patch_report cache

usage: refresh [--reset] [--verbose]

--reset         Allow refresh during a cache reset
--verbose       Output logging information to stderr

Intended to be run from a cron-job.
"""
import os
import sys


from patch_report import cache
from patch_report import simplelog
from patch_report import utils
from patch_report.models import patch_report


PIDFILE = '/tmp/refresh.pid'
RESET_CACHE_PIDFILE= '/tmp/reset-cache.pid'


if __name__ == '__main__':
    args = sys.argv[1:]
    verbose = '--verbose' in args
    reset = '--reset' in args

    if os.path.exists(RESET_CACHE_PIDFILE) and not reset:
        sys.exit(0)

    with utils.pidfile_guard(PIDFILE):
        simplelog.set_verbose(verbose)
        patch_report.refresh()
