#!/usr/bin/env python
"""
Refresh patch_report cache

usage: refresh [--clear-cache] [--verbose]

--clear-cache   Will clear the cache so that issues and upstream reviews can
                be refreshed.

--verbose       Output logging information to stderr

Intended to be run from a cron-job.
"""
import os
import sys


from patch_report import cache
from patch_report import simplelog
from patch_report.models import patch_report


PIDFILE = '/tmp/refresh.pid'

if os.path.exists(PIDFILE):
    sys.exit(1)

with open(PIDFILE, 'w') as f:
    f.write(str(os.getpid()))

try:
    args = sys.argv[1:]

    clear_cache = '--clear-cache' in args
    verbose = '--verbose' in args
    simplelog.set_verbose(verbose)

    if clear_cache:
        cache.clear()

    patch_report.refresh()
finally:
    os.unlink(PIDFILE)
