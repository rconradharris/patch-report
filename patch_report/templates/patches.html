{% macro sort_heading(key, name=None) %}
    {% set is_sort_key = key == sort_key %}
    <th class="{{ 'sort-key' if is_sort_key else '' }}">
    {% if is_sort_key %}
        {% set sort_dir = 'desc' if sort_dir == 'asc' else 'asc' %}
    {% else %}
        {% set sort_dir = 'asc' %}
    {% endif %}
    {% if name is none %}
        {% set name = key.replace('_', ' ').title() %}
    {% endif %}
    <a href="{{ url_for('patches', sort_key=key, sort_dir=sort_dir) }}"
       class="sort-link">{{ name }}
    {% if is_sort_key %}
        <span id="sort-caret" class="glyphicon glyphicon-chevron-{{ 'up' if sort_dir == 'asc' else 'down' }}"</span>
    {% endif %}
    </th>
</a>
{% endmacro %}


{% macro modal(id, title) %}
    <div class="modal fade" id="{{ id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="myModalLabel">{{ title }}</h4>
          </div>
          <div class="modal-body">
            {{ caller()|safe }}
          </div>
        </div>
      </div>
    </div>
{% endmacro %}


{% macro pluralize(count, singular, plural) %}
    {{ singular if count == 1 else plural }}
{% endmacro %}


{% macro gr_link(gr) %}
    <a class="btn btn-success btn-xs"
       target="_blank"
       href="{{ gr.url }}">{{ gr.change_id[:5] }}</a>
   {% endmacro %}


{% macro gr_list_modal(patch) %}
    {% call modal('gr-modal-%s' % patch.idx, 'Upstream Reviews') %}
        <ol class="btn-list">
            {% for gr in patch.gerrit_reviews %}
                <li>{{ gr_link(gr) }}</li>
            {% endfor %}
        </ol>
    {% endcall %}
    <a data-toggle="modal" data-target="#gr-modal-{{ patch.idx }}"
       href="javascript:void(0)">{{ patch.gerrit_reviews|count }} reviews</a>
{% endmacro %}


{% macro rm_list_modal(patch) %}
    {% call modal('rm-modal-%s' % patch.idx,
                  'Redmine Issues for %s' % patch.filename) %}

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Issue #</th>
                    <th>Description</th>
                    <th class="rightcol">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for rm_issue in patch.rm_issues %}
                <tr>
                    <td>
                        <span class="label label-danger">{{ rm_issue.issue_id }}</span>
                    </td>
                    <td>
                        <a target="_blank"
                            href="{{ rm_issue.url }}">{{ rm_issue.subject or '<Issue Not Found>'}}</a>
                    </td>
                    <td class="rightcol">
                        <span class="label label-default">{{ rm_issue.status }}</span>
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endcall %}
    <a data-toggle="modal" data-target="#rm-modal-{{ patch.idx }}"
        href="javascript:void(0)">
        {% with issue_count = patch.rm_issues|count %}
            {% if issue_count == 1 %}
                <span class="label label-danger">{{ patch.rm_issues[0].issue_id }}</span>
            {% else %}
                {{ issue_count }} {{ pluralize(issue_count, 'issue', 'issues') }}
            {% endif %}
        {% endwith %}
    </a>
{% endmacro %}


{% macro file_list_modal(patch) %}
    {% call modal('files-modal-%s' % patch.idx, 'Files Modified') %}
        <ol>
            {% for filename in patch.files %}
                <li>{{ filename }}</li>
            {% endfor %}
        </ol>
    {% endcall %}
    <a data-toggle="modal" data-target="#files-modal-{{ patch.idx }}" href="javascript:void(0)">{{ patch.file_count }}</a>
{% endmacro %}


<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>PatchRepo</title>
        <link href="static/css/bootstrap.min.css" rel="stylesheet">
        <style>
            #main { margin-top: 50px; margin-bottom: 50px; }
            #sort-caret { float: right; }
            .sort-key { background: #eee; }
            .sort-link { display: block; width: 100%; height: 100%; }
            ol.btn-list li { margin-bottom: 5px; }
            .rightcol { text-align: right; }
        </style>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <!-- Navbar -->
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
          <div class="container-fluid">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="{{ url_for('index') }}">PatchRepo</a>
            </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav navbar-right">
                <li><a href="{{ url_for('patches') }}">Patches</a></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Main Container -->
        <div id="main" class="container-fluid">
            <table class="table table-striped">
            <thead>
                <tr>
                    {{ sort_heading('idx', name='#') }}
                    {{ sort_heading('date') }}
                    {{ sort_heading('filename') }}
                    {{ sort_heading('author') }}
                    {{ sort_heading('line_count') }}
                    {{ sort_heading('file_count') }}
                    {{ sort_heading('rm_issue_count',
                                    name='Redmine Issues') }}
                    {{ sort_heading('gerrit_review_count',
                                    name='Upstream Reviews') }}
                </tr>
            </thead>
            {% for patch in patches %}
                <tr>
                    <td>{{ patch.idx }} </td>
                    <td>{{ patch.date.date() }} </td>
                    <td><a target="_blank" href="{{ patch.url }}">{{ patch.filename }}</a></td>
                    <td>{{ patch.author }} </td>
                    <td>{{ patch.line_count }}</td>
                    <td>{{ file_list_modal(patch) }}</td>
                    <td>
                        {% if patch.rm_issue_count > 0 %}
                            {{ rm_list_modal(patch) }}
                        {% endif %}
                    </td>
                    <td>
                        {% if patch.gerrit_review_count == 0 %}
                        {% elif patch.gerrit_review_count == 1 %}
                            {{ gr_link(patch.gerrit_reviews[0]) }}
                        {% else %}
                            {{ gr_list_modal(patch) }}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </table>
            Last Updated: {{ last_updated_at }} UTC
        </div>
        <script src="static/js/jquery.min.js"></script>
        <script src="static/js/bootstrap.min.js"></script>
    </body>
</html>
