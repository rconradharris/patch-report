{% extends 'project/_layout.html' %}
{% import 'macros.html' as macros %}

{% macro issues_modal_link(patch) %}
    <a data-toggle="modal" data-target="#rm-modal-{{ patch.idx }}"
        href="javascript:void(0)">
        {% with issue_count = patch.rm_issues|count %}
            {% if issue_count == 1 %}
                <span class="label label-danger">{{ patch.rm_issues[0].issue_id }}</span>
            {% else %}
                {{ issue_count }} {{ macros.pluralize(issue_count, 'issue') }}
            {% endif %}
        {% endwith %}
    </a>
{% endmacro %}

{% macro issues_modal(patch, max_subject_length=50) %}
    {% call macros.modal('rm-modal-%s' % patch.idx,
                         'Issues for %s' % patch.filename) %}

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Issue #</th>
                    <th>Description</th>
                    <th class="rightcol">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for rm_issue in patch.rm_issues %}
                <tr>
                    <td>
                        <span class="label label-danger">{{ rm_issue.issue_id }}</span>
                    </td>
                    <td>
                        <a target="_blank" href="{{ rm_issue.url }}">{{ rm_issue.subject|truncate(max_subject_length, True) }}</a>
                    </td>
                    <td class="rightcol">
                        <span class="label label-default">{{ rm_issue.status }}</span>
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endcall %}
{% endmacro %}

{% macro files_modal_link(patch) %}
    <a data-toggle="modal" data-target="#files-modal-{{ patch.idx }}" href="javascript:void(0)">{{ patch.file_count }}</a>
{% endmacro %}

{% macro files_modal(patch) %}
    {% call macros.modal('files-modal-%s' % patch.idx, 'Files Modified') %}
        <ol>
            {% for filename in patch.files %}
                <li>{{ filename }}</li>
            {% endfor %}
        </ol>
    {% endcall %}
{% endmacro %}

{% block title %}
{{ project.name }} Patches
{% endblock title %}

{% block tab_container %}
{% for patch in patches %}
    {% if patch.rm_issue_count > 0 %}
        {{ issues_modal(patch) }}
    {% endif %}
    {{ files_modal(patch) }}
    {{ macros.upstream_reviews_modal(patch) }}
{% endfor %}

<table class="table table-striped">
<thead>
    <tr>
        {{ macros.sort_heading('idx', name='#') }}
        {{ macros.sort_heading('date') }}
        {{ macros.sort_heading('filename') }}
        {{ macros.sort_heading('author') }}
        {{ macros.sort_heading('rm_issue_count',
                               name='Attached Issues',
                               align_right=True) }}
        {{ macros.sort_heading('upstream_review_count',
                               name='Upstream Reviews',
                               align_right=True) }}
        {{ macros.sort_heading('file_count', align_right=True) }}
        {{ macros.sort_heading('line_count', align_right=True) }}
    </tr>
</thead>
{% for patch in patches %}
    <tr>
        <td>{{ patch.idx }} </td>
        <td>{{ patch.date.date() }} </td>
        <td>{{ macros.patch_link(patch) }}</td>
        <td>{{ patch.author }} </td>
        <td class="rightcol">
            {% if patch.rm_issue_count > 0 %}
                {{ issues_modal_link(patch) }}
            {% endif %}
        </td>
        <td class="rightcol">
            {% if patch.upstream_review_count > 0 %}
                {{ macros.upstream_reviews_modal_link(patch) }}
            {% endif %}
        </td>
        <td class="rightcol">{{ files_modal_link(patch) }}</td>
        <td class="rightcol">{{ patch.line_count }}</td>
    </tr>
{% else %}
    <tr>
        <td class="placeholder-row" colspan="8">No patches in repo</td>
    </tr>
{% endfor %}
</table>
{% endblock tab_container %}
