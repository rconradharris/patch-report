{% extends 'project/_layout.html' %}

{% macro sort_heading(key, name=None, align_right=False) %}
    {% set is_sort_key = key == sort_key %}
    <th class="{{ 'sort-key' if is_sort_key else '' }} {{ 'rightcol' if align_right else '' }}">
    {% if is_sort_key %}
        {% set sort_dir = 'desc' if sort_dir == 'asc' else 'asc' %}
    {% else %}
        {% set sort_dir = 'asc' %}
    {% endif %}
    {% if name is none %}
        {% set name = key.replace('_', ' ').title() %}
    {% endif %}
    <a href="{{ url_for('project_patches', project=project, sort_key=key, sort_dir=sort_dir) }}"
       class="sort-link">{{ name }}
    {% if is_sort_key %}
        <span id="sort-caret" class="glyphicon glyphicon-chevron-{{ 'up' if sort_dir == 'asc' else 'down' }}"</span>
    {% endif %}
    </th>
</a>
{% endmacro %}


{% macro modal(id, title, truncate_length=50) %}
    <div class="modal fade" id="{{ id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="myModalLabel">{{ title|truncate(truncate_length, True) }}</h4>
          </div>
          <div class="modal-body">
            {{ caller()|safe }}
          </div>
        </div>
      </div>
    </div>
{% endmacro %}


{% macro pluralize(count, singular, plural) %}
    {{ singular if count == 1 else plural }}
{% endmacro %}


{% macro gr_link(gr) %}
    <a class="btn btn-success btn-xs"
       target="_blank"
       href="{{ gr.url }}">{{ gr.change_id[:5] }}</a>
   {% endmacro %}


{% macro gr_list_modal(patch) %}
    {% call modal('gr-modal-%s' % patch.idx, 'Upstream Reviews') %}
        <ol class="btn-list">
            {% for gr in patch.upstream_reviews %}
                <li>{{ gr_link(gr) }}</li>
            {% endfor %}
        </ol>
    {% endcall %}
    <a data-toggle="modal" data-target="#gr-modal-{{ patch.idx }}"
       href="javascript:void(0)">{{ patch.upstream_reviews|count }} reviews</a>
{% endmacro %}

{% macro issues_modal_link(patch) %}
    <a data-toggle="modal" data-target="#rm-modal-{{ patch.idx }}"
        href="javascript:void(0)">
        {% with issue_count = patch.rm_issues|count %}
            {% if issue_count == 1 %}
                <span class="label label-danger">{{ patch.rm_issues[0].issue_id }}</span>
            {% else %}
                {{ issue_count }} {{ pluralize(issue_count, 'issue', 'issues') }}
            {% endif %}
        {% endwith %}
    </a>
{% endmacro %}

{% macro issues_modal(patch, max_subject_length=50) %}
    {% call modal('rm-modal-%s' % patch.idx,
                  'Issues for %s' % patch.filename) %}

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Issue #</th>
                    <th>Description</th>
                    <th class="rightcol">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for rm_issue in patch.rm_issues %}
                <tr>
                    <td>
                        <span class="label label-danger">{{ rm_issue.issue_id }}</span>
                    </td>
                    <td>
                        {% if rm_issue.subject %}
                            {% set subject = rm_issue.subject|truncate(max_subject_length,
                            True) %}
                        {% else %}
                            {% set subject = '<Issue Not Found>' %}
                        {% endif %}
                        <a target="_blank" href="{{ rm_issue.url }}">{{ subject }}</a>
                    </td>
                    <td class="rightcol">
                        <span class="label label-default">{{ rm_issue.status }}</span>
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endcall %}
{% endmacro %}

{% macro files_modal_link(patch) %}
    <a data-toggle="modal" data-target="#files-modal-{{ patch.idx }}" href="javascript:void(0)">{{ patch.file_count }}</a>
{% endmacro %}

{% macro files_modal(patch) %}
    {% call modal('files-modal-%s' % patch.idx, 'Files Modified') %}
        <ol>
            {% for filename in patch.files %}
                <li>{{ filename }}</li>
            {% endfor %}
        </ol>
    {% endcall %}
{% endmacro %}

{% block title %}
{{ project }} Patches
{% endblock title %}

{% block tab_container %}
{% for patch in patches %}
    {% if patch.rm_issue_count > 0 %}
        {{ issues_modal(patch) }}
    {% endif %}
    {{ files_modal(patch) }}
{% endfor %}


<table class="table table-striped">
<thead>
    <tr>
        {{ sort_heading('idx', name='#') }}
        {{ sort_heading('date') }}
        {{ sort_heading('filename') }}
        {{ sort_heading('author') }}
        {{ sort_heading('rm_issue_count',
                        name='Attached Issues',
                        align_right=True) }}
        {{ sort_heading('upstream_review_count',
                        name='Upstream Reviews',
                        align_right=True) }}
        {{ sort_heading('file_count', align_right=True) }}
        {{ sort_heading('line_count', align_right=True) }}
    </tr>
</thead>
{% for patch in patches %}
    <tr>
        <td>{{ patch.idx }} </td>
        <td>{{ patch.date.date() }} </td>
        <td><a target="_blank" href="{{ patch.url }}">{{ patch.filename|truncate(32, True) }}</a></td>
        <td>{{ patch.author }} </td>
        <td class="rightcol">
            {% if patch.rm_issue_count > 0 %}
                {{ issues_modal_link(patch) }}
            {% endif %}
        </td>
        <td class="rightcol">
            {% if patch.upstream_review_count == 0 %}
            {% elif patch.upstream_review_count == 1 %}
                {{ gr_link(patch.upstream_reviews[0]) }}
            {% else %}
                {{ gr_list_modal(patch) }}
            {% endif %}
        </td>
        <td class="rightcol">{{ files_modal_link(patch) }}</td>
        <td class="rightcol">{{ patch.line_count }}</td>
    </tr>
{% else %}
    <tr>
        <td class="placeholder-row" colspan="8">No patches in repo</td>
    </tr>
{% endfor %}
</table>
{% endblock tab_container %}
